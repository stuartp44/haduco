name: CI/CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Linting
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_test.txt

      - name: Ruff (linter)
        run: ruff check .

      - name: Ruff (formatter)
        run: ruff format --check .

      - name: mypy
        run: mypy custom_components/duco_ventilation_sun_control

  hacs-validation:
    runs-on: ubuntu-latest
    name: HACS Validation
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration

  hassfest:
    runs-on: ubuntu-latest
    name: Hassfest Validation
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4

      - name: Hassfest validation
        uses: home-assistant/actions/hassfest@master

  release:
    runs-on: ubuntu-latest
    name: Semantic Release
    needs: [lint, hacs-validation, hassfest]
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install semantic-release
        run: |
          npm install -g semantic-release@23 \
            @semantic-release/changelog@6 \
            @semantic-release/git@10 \
            @semantic-release/github@10 \
            @semantic-release/exec@6 \
            conventional-changelog-conventionalcommits@7

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release

  acknowledge-contributors:
    runs-on: ubuntu-latest
    name: Update Contributors
    needs: release
    if: success()
    steps:
      - name: Check out code from GitHub
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update CONTRIBUTORS.md
        uses: akhilmhdh/contributors-readme-action@v2.3.11
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          image_size: 100
          columns_per_row: 6
          committer_username: github-actions[bot]
          committer_email: github-actions[bot]@users.noreply.github.com
          readme_path: CONTRIBUTORS.md
          commit_message: "docs: update contributors [skip ci]"

      - name: Comment on release
        if: success()
        uses: actions/github-script@v8
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            if (releases.length > 0) {
              const latestRelease = releases[0];
              await github.rest.repos.createReleaseDiscussion({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: latestRelease.id,
                body: 'Thank you to all our contributors for making this release possible!\n\nSpecial thanks to [@Sikerdebaard](https://github.com/Sikerdebaard) for creating this project.\n\nCheck out [CONTRIBUTORS.md](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/CONTRIBUTORS.md) for the full list of contributors.'
              }).catch(() => {
                console.log('Could not create release discussion');
              });
            }
